import pandas as pd
import random
import string

def generate_random_string(length):
    chars = string.ascii_letters + string.digits
    return ''.join(random.choice(chars) for _ in range(length))

def mask_with_random_chars(val):
    if pd.isnull(val):
        return val
    try:
        val_str = str(int(float(val)))  # Convert numeric to string
        return generate_random_string(len(val_str))
    except:
        return val

def mask_column_in_all_sheets(file_path, column_name, output_file):
    # Read all sheets
    all_sheets = pd.read_excel(file_path, sheet_name=None)

    # Dict to store updated dataframes
    updated_sheets = {}

    for sheet_name, df in all_sheets.items():
        print(f"Processing sheet: {sheet_name}")

        # Clean column names
        df.columns = df.columns.str.strip()

        if column_name in df.columns:
            print(f"Masking column '{column_name}' in sheet '{sheet_name}'")
            df[column_name] = df[column_name].apply(mask_with_random_chars)
        else:
            print(f"Column '{column_name}' not found in sheet '{sheet_name}'")

        # Save updated DataFrame to dictionary
        updated_sheets[sheet_name] = df

    # Write all sheets back to a single Excel file
    with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
        for sheet_name, df in updated_sheets.items():
            df.to_excel(writer, sheet_name=sheet_name, index=False)

    print(f"\nâœ… Masked Excel saved to: {output_file}")